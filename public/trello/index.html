<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://bxp-content-static.prod.public.atl-paas.net/img/favicon.ico">
  <title>红狐入梦的Trello</title>
  <style>
    :root {
      --button-color: #5aac44;
      --editing-color: #ffcccc;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      overflow-x: auto;
      user-select: none;
    }

    .board-container {
      display: flex;
      /* 允许水平滚动 */
      padding: 10px;
    }

    .board {
      display: flex;
      flex-wrap: nowrap;
      /* 防止列表换行 */
    }

    .list,
    .add-list {
      background-color: #ffb8b8;
      border-radius: 3px;
      margin: 0 10px;
      width: 250px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      height: fit-content;
    }

    .list-header {
      font-weight: bold;
      margin-bottom: 10px;
      cursor: pointer;
      min-height: 20px;
      /* 当文字为空时保持高度 */
    }

    .card {
      background-color: #fff;
      border-radius: 3px;
      box-shadow: 0 1px 0 rgba(9, 30, 66, 0.25);
      margin-bottom: 10px;
      padding: 10px;
      cursor: pointer;
    }

    .card-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .card-content {
      font-size: 14px;
      white-space: pre-wrap;
      font-family: Arial, Helvetica, sans-serif;
      margin-top: -3px;
      margin-bottom: -3px;
    }

    .add-card-btn,
    .add-list-btn {
      background-color: var(--button-color);
      border: none;
      color: white;
      padding: 5px;
      cursor: pointer;
      border-radius: 3px;
      margin-top: 10px;
    }

    #upload {
      background-color: var(--button-color);
      border: none;
      color: white;
      padding: 5px;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 30px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.2);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 5px;
      box-shadow: var(--editing-color) -8px 0px 0px;
      width: 80%;
      max-width: 500px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    @media only screen and (max-width: 600px) {
      body {
        padding: 10px;
      }

      /* .board-container {
                overflow-x: scroll;
                white-space: nowrap;
            } */

      .card {
        width: calc(100% - 20px);
        margin-right: 20px;
      }

      .modal {
        width: 100%;
      }

      .modal-content {
        width: 80%;
        margin: 5% auto;
      }

      #upload {
        margin-left: 10px;
        margin-right: 10px;
      }

      #background-color {
        margin-left: 10px;
      }
    }
  </style>
</head>

<body>
  <div>
    <label for="editTitle" style="font-size: large; margin-right: 30px; font-weight: bold">红狐入梦的Trello</label>
    <button id="upload" onclick="upload()">上传保存</button>
    <label for="upload" id="saveStatus" style="margin-right: 30px;margin-left: 5px;">下载完成</label>
    <label for="background-color">选择背景颜色: </label>
    <input type="color" id="background-color" style="margin-right: 30px;" />
    <label for="button-color">选择按钮颜色: </label>
    <input type="color" id="button-color" />
  </div>

  <div class="board-container">
    <div id="board" class="board"></div>
  </div>

  <!-- Modal for editing -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <label for="editTitle">标题:</label>
      <button id="clearTitle">清除</button>
      <input type="text" id="editTitle" style="width: 100%; margin-bottom: 10px;" autocomplete="off" />
      <label for="editContent">内容:</label>
      <button id="clearContent">清除</button>
      <textarea id="editContent" rows="4" style="width: 100%; margin-top: 10px; margin-bottom: 5px"></textarea>

      <div style="display: flex;margin-bottom: 10px;display: flex;">
        <label for="card-background-color" style="margin-right: 5px;">颜色:</label>
        <input type="color" id="card-background-color" value="#FFFFFF" />
        <div style="width: 25px;height: 25px;background-color: #607D8B;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #FFB74D;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #FFECB3;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #FFAB91;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #FF80AB;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #4FC3F7;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #80DEEA;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #FFB8B8;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #E0E0E0;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #fffbbd;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #CCFFCC;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
      </div>
      <div style="display: flex;margin-bottom: 10px;display: flex;">
        <div style="width: 25px;height: 25px;background-color: #3eb682;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #37d2b8;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #885fb9;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #c296ee;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
        <div style="width: 25px;height: 25px;background-color: #ccccff;margin-left: 10px;"
          onclick="chooseColor(this.style.backgroundColor)"></div>
      </div>

      <button id="saveEdit">保存</button>
      <button id="delEdit">删除</button>
    </div>
  </div>

  <script src="../mtoast.js"></script>
  <script src="../Sortable.min.js"></script>
  <script>
    var backgroundColor = "#ffcccc";
    var allButtonColor = "#885fb9";
    var data = [
      {
        title: "待办",
        cards: [
          {
            title: "任务 1",
            content: "内容 1",
            color: "#ffcccc",
          },
          { title: "任务 2", content: "内容 2", color: "#ccffcc" },
        ],
        color: "#ffb8b8",
      },
      {
        title: "进行中",
        cards: [{ title: "任务 3", content: "内容 3", color: "#ccccff" }],
        color: "#fffbbd",
      },
      {
        title: "已完成",
        cards: [{ title: "任务 4", content: "内容 4", color: "#ccccff" }],
        color: "#37d2b8",
      },
    ];

    function saveTrelloListInfo() {
      let listElements = document.querySelectorAll(".list");
      let listInfo = [];
      listElements.forEach((listElement, listIndex) => {
        let list = {
          title: listElement.querySelector(".list-header").textContent,
          color: rgbToHex(listElement.style.backgroundColor),
          cards: [],
        };
        let cardElements = listElement.querySelectorAll(".card");
        cardElements.forEach((cardElement, cardIndex) => {
          let card = {
            title: cardElement.querySelector(".card-title").textContent,
            content: cardElement.querySelector(".card-content").textContent,
            color: rgbToHex(cardElement.style.backgroundColor),
          };
          list.cards.push(card);
        });
        listInfo.push(list);
      });
      data = listInfo;
      document.getElementById("saveStatus").textContent = "未上传";
      // console.log(data);
    }

    let editTarget = null;

    function createCardElement(card, cardIndex, listIndex) {
      const cardElement = document.createElement("div");
      cardElement.className = "card";
      cardElement.style.backgroundColor = card.color;
      // cardElement.setAttribute("list", listIndex);
      // cardElement.setAttribute("card", cardIndex);

      const cardTitle = document.createElement("div");
      cardTitle.className = "card-title";
      cardTitle.textContent = card.title;
      cardElement.appendChild(cardTitle);

      const cardContent = document.createElement("pre");
      cardContent.className = "card-content";
      cardContent.textContent = card.content;
      // cardContent.innerHTML = card.content.replace(/\n/g, "</br>");
      cardElement.appendChild(cardContent);

      cardElement.addEventListener("click", (e) => {
        editTarget = e.target;
        document.getElementById("editTitle").value = cardTitle.textContent;
        document.getElementById("editContent").value =
          cardContent.textContent;
        document.getElementById("card-background-color").value = card.color;
        document.documentElement.style.setProperty(
          "--editing-color",
          cardElement.style.backgroundColor
        );
        document.getElementById("editModal").style.display = "block";
      });

      return cardElement;
    }

    function createListElement(list, listIndex) {
      const listElement = document.createElement("div");
      listElement.className = "list";
      listElement.style.backgroundColor = list.color;

      const listHeader = document.createElement("div");
      listHeader.className = "list-header";
      listHeader.textContent = list.title;
      // listHeader.setAttribute("list", listIndex);
      listHeader.addEventListener("click", (e) => {
        editTarget = e.target;
        document.getElementById("editTitle").value = listHeader.textContent;
        document.getElementById("editContent").value = "编辑无用";
        document.getElementById("card-background-color").value = list.color;
        document.documentElement.style.setProperty(
          "--editing-color",
          listElement.style.backgroundColor
        );
        document.getElementById("editModal").style.display = "block";
      });
      listElement.appendChild(listHeader);

      list.cards.forEach((card, index) => {
        const cardElement = createCardElement(card, index, listIndex);
        listElement.appendChild(cardElement);
      });

      Sortable.create(listElement, {
        group: "cards",
        animation: 150,
        draggable: ".card",
        filter: ".add-card-btn",
        onSort: function (evt) {
          // 当列表中可拖动的元素为0时，再次添加卡片，会出现在不可拖动的按钮之后
          // 发现卡片在按钮之后时，将其放在添加卡片按钮之前
          var addCardBtn = evt.to.querySelector(".add-card-btn");
          if (addCardBtn && addCardBtn.nextElementSibling === evt.item) {
            evt.to.insertBefore(evt.item, addCardBtn);
          }
        },
        onEnd: function (evt) {
          saveTrelloListInfo();
        },
      });

      const addCardButton = document.createElement("button");
      addCardButton.className = "add-card-btn";
      addCardButton.textContent = "添加卡片";
      addCardButton.addEventListener("click", () => {
        const newCard = {
          title: "新任务",
          content: "新内容",
          color: "#CCFFCC",
        };
        const cardElement = createCardElement(
          newCard,
          list.cards.length - 1,
          listIndex
        );
        listElement.insertBefore(cardElement, addCardButton);
        saveTrelloListInfo();
      });

      listElement.appendChild(addCardButton);

      return listElement;
    }

    function renderBoard() {
      document.body.style.backgroundColor = backgroundColor;
      document.getElementById("background-color").value = backgroundColor;
      document.getElementById("button-color").value = allButtonColor;
      document.documentElement.style.setProperty(
        "--button-color",
        allButtonColor
      );

      const board = document.getElementById("board");
      board.innerHTML = "";

      data.forEach((list, index) => {
        const listElement = createListElement(list, index);
        board.appendChild(listElement);
      });

      Sortable.create(board, {
        animation: 150,
        draggable: ".list",
        onEnd: function (evt) {
          saveTrelloListInfo();
        },
      });

      const listPlaceholder = document.createElement("div");
      listPlaceholder.className = "add-list";

      const addListButton = document.createElement("button");
      addListButton.className = "add-list-btn";
      addListButton.textContent = "添加列表";
      addListButton.addEventListener("click", () => {
        const newList = { title: "新列表", cards: [], color: "#ffb8b8" };
        saveTrelloListInfo();
        renderBoard();
      });

      listPlaceholder.appendChild(addListButton);
      board.appendChild(listPlaceholder);
    }

    document
      .getElementById("background-color")
      .addEventListener("input", (e) => {
        backgroundColor = e.target.value;
        document.body.style.backgroundColor = e.target.value;
      });

    document
      .getElementById("button-color")
      .addEventListener("input", (e) => {
        allButtonColor = e.target.value;
        document.documentElement.style.setProperty(
          "--button-color",
          e.target.value
        );
      });

    document.getElementById("saveEdit").addEventListener("click", () => {
      if (editTarget) {
        //   console.log(editTarget);
        if (editTarget.className === "list-header") {
          // let listIndex = editTarget.getAttribute("list");
          // data[listIndex].title = document.getElementById("editTitle").value;
          // data[listIndex].color = document.getElementById(
          //   "card-background-color"
          // ).value;
          editTarget.parentElement.style.backgroundColor =
            document.getElementById("card-background-color").value;
          editTarget.textContent = document.getElementById("editTitle").value;
        } else if (editTarget.className.includes("card")) {
          if (editTarget.className !== "card") {
            editTarget = editTarget.parentElement;
          }
          // let listIndex = editTarget.getAttribute("list");
          // let cardIndex = editTarget.getAttribute("card");
          // data[listIndex].cards[cardIndex].title =
          //   document.getElementById("editTitle").value;
          // data[listIndex].cards[cardIndex].content =
          //   document.getElementById("editContent").value;
          // data[listIndex].cards[cardIndex].color = document.getElementById(
          //   "card-background-color"
          // ).value;
          editTarget.style.backgroundColor = document.getElementById(
            "card-background-color"
          ).value;
          editTarget.querySelector(".card-title").innerHTML =
            document.getElementById("editTitle").value;
          editTarget.querySelector(".card-content").innerHTML =
            document.getElementById("editContent").value;
        }
        saveTrelloListInfo();
        document.getElementById("editModal").style.display = "none";
      }
    });

    document.getElementById("delEdit").addEventListener("click", () => {
      if (editTarget) {
        if (editTarget.className === "list-header") {
          // let listIndex = editTarget.getAttribute("list");
          // data.splice(listIndex, 1);
          editTarget.remove();
        } else if (editTarget.className.includes("card")) {
          if (editTarget.className !== "card") {
            editTarget = editTarget.parentElement;
          }
          editTarget.remove();
          // let listIndex = editTarget.getAttribute("list");
          // let cardIndex = editTarget.getAttribute("card");
          // data[listIndex].cards.splice(cardIndex, 1);
        }
        saveTrelloListInfo();
        document.getElementById("editModal").style.display = "none";
        // renderBoard();
      }
    });

    document.getElementById("clearTitle").addEventListener("click", () => {
      document.getElementById("editTitle").value = "";
    });

    document.getElementById("clearContent").addEventListener("click", () => {
      document.getElementById("editContent").value = "";
    });

    document.querySelector(".close").addEventListener("click", () => {
      document.getElementById("editModal").style.display = "none";
    });

    // 检查是不是正在使用输入法输入
    let isComposing = false;

    window.addEventListener('compositionstart', () => {
      isComposing = true;
    });

    window.addEventListener('compositionend', () => {
      isComposing = false;
    });

    window.addEventListener("keydown", (event) => {
      if (
        !isComposing &&
        event.key === "Enter" &&
        document.getElementById("editModal").style.display === "block" &&
        document.activeElement.tagName !== "TEXTAREA"
      ) {
        document.getElementById("saveEdit").click();
      }
    });

    function chooseColor(color) {
      document.getElementById("card-background-color").value = rgbToHex(color);
      document.documentElement.style.setProperty("--editing-color", color);
    }

    function rgbToHex(rgb) {
      let [r, g, b] = rgb.match(/\d+/g).map(Number);
      r = r.toString(16).padStart(2, '0');
      g = g.toString(16).padStart(2, '0');
      b = b.toString(16).padStart(2, '0');
      return `#${r}${g}${b}`;
    }

    function upload() {
      fetch("/saveTrello", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ data, backgroundColor, allButtonColor }),
      }).then((response) => {
        if (response.ok) {
          autolog.success("保存成功");
          document.getElementById("saveStatus").textContent = "已上传";
        } else {
          autolog.error("保存失败");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetch("/getTrello")
        .then((response) => response.json())
        .then((res) => {
          if (res.success) {
            // console.log(res);
            data = res.data.data;
            backgroundColor = res.data.backgroundColor;
            if (res.data.allButtonColor) {
              allButtonColor = res.data.allButtonColor;
            }
          } else {
            autolog.error("获取失败");
          }
          renderBoard();
        })
        .catch((err) => {
          console.log(err);
          autolog.error("获取失败");
          renderBoard();
        });
    });

    // 记录鼠标按下时的初始位置和页面滚动位置
    let initialMouseX = 0;
    let initialMouseY = 0;
    let initialScrollX = 0;
    let initialScrollY = 0;

    // 监听鼠标按下事件
    document.addEventListener("mousedown", (event) => {
      // 如果鼠标按下的位置不在 html 或 id 为 board 的元素上，就返回
      if (!(event.target.nodeName === 'HTML' || event.target.id === 'board')) return;
      // console.log(event.target);
      initialMouseX = event.clientX;
      initialMouseY = event.clientY;
      initialScrollX = window.scrollX;
      initialScrollY = window.scrollY;

      // 监听鼠标移动事件
      document.addEventListener("mousemove", handleMouseMove);

      // 监听鼠标释放事件
      document.addEventListener("mouseup", () => {
        document.removeEventListener("mousemove", handleMouseMove);
      });
    });

    // 处理鼠标移动事件
    function handleMouseMove(event) {
      const deltaX = event.clientX - initialMouseX;
      const deltaY = event.clientY - initialMouseY;

      window.scrollTo(initialScrollX - deltaX, initialScrollY - deltaY);
    }

    window.onbeforeunload = function () {
      return "您有未保存的更改，确定要关闭页面吗？";
    };
  </script>
</body>

</html>