<!DOCTYPE html>
<html>

<head>
    <title>Honghurumeng</title>
    <link rel="icon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center center;
            background-repeat: repeat;
            background-image: url("data:image/svg+xml;utf8,%3Csvg width=%222000%22 height=%221000%22 xmlns=%22http:%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath fill=%22%23e5eaff%22 d=%22M0 0h2000v1000H0z%22%2F%3E%3Cpath d=%22M0 142h0c99.631 3.982 199.263 7.964 308 0s226.581-27.875 354-20c127.419 7.875 264.413 43.536 366 45 101.587 1.464 167.765-31.267 274-34 106.235-2.733 252.525 24.533 381 23 128.475-1.533 239.136-31.867 289-39 49.864-7.133 38.932 8.933 68 25%22 fill=%22none%22 stroke=%22%23173fff%22 stroke-width=%224%22 stroke-linecap=%22round%22%2F%3E%3Cpath d=%22M0 285h0c122.483 16.216 244.966 32.433 359 27 114.034-5.433 219.617-32.515 334-33 114.383-.485 237.564 25.627 338 26 100.436.373 178.127-24.993 271-33 92.873-8.007 200.927 1.344 342 10s315.164 16.616 380 17c64.836.384 20.418-6.808 16-14%22 fill=%22none%22 stroke=%22%237e95ff%22 stroke-width=%224%22 stroke-linecap=%22round%22%2F%3E%3Cpath d=%22M0 428h0c116.4 2.31 232.8 4.618 347 0 114.2-4.618 226.2-16.164 330-13 103.8 3.164 199.402 21.038 317 28 117.598 6.962 257.191 3.01 363 4 105.809.99 177.833 6.92 288 4s258.476-14.692 324-20 48.262-4.154 71-3%22 fill=%22none%22 stroke=%22%2397a9ff%22 stroke-width=%224%22 stroke-linecap=%22round%22%2F%3E%3Cpath d=%22M0 571h0c116.767-1.202 233.534-2.403 352-5 118.466-2.597 238.631-6.588 345-13s198.941-15.243 306-7 228.603 33.56 339 33c110.397-.56 209.645-26.997 338-29s285.816 20.428 344 28c58.184 7.572 17.092.286 16-7%22 fill=%22none%22 stroke=%22%238298ff%22 stroke-width=%224%22 stroke-linecap=%22round%22%2F%3E%3Cpath d=%22M0 714h0c96.753 5.833 193.506 11.666 307 13 113.494 1.334 243.727-1.831 354-2 110.273-.169 200.584 2.66 313-6s246.936-28.806 357-21c110.064 7.806 195.671 43.563 317 43 121.329-.563 278.38-37.447 343-48 64.62-10.553 36.81 5.223 49 21%22 fill=%22none%22 stroke=%22%235572ff%22 stroke-width=%224%22 stroke-linecap=%22round%22%2F%3E%3Cpath d=%22M0 857h0c128.837-12.317 257.674-24.633 357-24 99.326.633 169.14 14.217 276 21 106.86 6.783 250.763 6.765 372 6 121.237-.765 219.806-2.277 321-6 101.194-3.723 205.014-9.656 329-14 123.986-4.344 268.139-7.098 329-4 60.861 3.098 38.43 12.05 56 21%22 fill=%22none%22 stroke=%22%23b5c2ff%22 stroke-width=%224%22 stroke-linecap=%22round%22%2F%3E%3C%2Fsvg%3E");
        }

        button {
            background-color: #4CAF50;
            height: 38.5px;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3e8e41;
        }

        #download-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            /* 控制按钮之间的间距 */
        }

        #download-table {
            /* width: 100%; */
            border-collapse: collapse;
        }

        #download-table th,
        #download-table td {
            border: 1px solid #787878;
            border-style: dotted;
            padding: 8px;
            text-align: center;
        }

        /* #download-table th {
            background-color: #f2f2f2;
        } */

        /* 响应式布局 */
        @media (max-width: 600px) {
            h1 {
                font-size: 24px;
            }

            button {
                width: 80%;
                margin-bottom: 10px;
                margin-left: 10%;
            }

            .text {
                width: 80%;
                height: 50px;
                margin-left: 10%;
            }

            .refresh-table-btn{
                width: auto;
            }
        }
    </style>
</head>

<body>
    <h1>Hello, Master!</h1>
    <!-- <button onclick="openBlog()">Github</button> -->
    <button onclick="openRouge()">phaser game</button>
    <button onclick="open3d()">threejs</button>
    <button onclick="openlaygame()">放置游戏</button>
    <button onclick="openTrello()">Trello</button>
    <button onclick="checkServerStatus()">查询服务器状态</button>
    <!-- 还可以设置可选的文件类型 accept=".json" -->
    <input type="file" id="fileInput" style="display: none;" onchange="confirmUploadFile()">
    <button onclick="document.getElementById('fileInput').click()">上传文件到服务器</button>
    <h3>Downloads<button style="margin-left: 10px;" class="refresh-table-btn" onclick="getAppNames()">刷新</button></h3>
    <div id="download-btns" style="margin-top: 20px;">
        <table id="download-table">
            <tr>
                <th>文件名</th>
                <th>操作</th>
            </tr>
        </table>
    </div>
    <h3>News</h3>
    <div>
        <textarea name="danmu" id="danmu" class="text"></textarea>
        <textarea name="" id="" class="text"></textarea>
        <textarea name="1" id="infoback" class="text"></textarea>
        <button onclick="send()">发送</button>
    </div>
</body>
<script src="./mtoast.js"></script>
<script>
    function openTrello() {
        window.open('/trello/index.html', '_blank');
    }

    function confirmUploadFile() {
        if (confirm('Are you sure to upload this file?')) {
            uploadFile();
        } else {
            autolog.info('Upload canceled');
        }
    }

    function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            autolog.error('No file selected');
            return;
        }
        const utf8FileName = new TextEncoder().encode(file.name);
        const formData = new FormData();
        formData.append('file', file);
        formData.append('filename', file.name); // 编码文件名

        fetch('/api/uploadFile', {
            method: 'POST',
            body: formData
        })
            .then(response => response.text())
            .then(data => {
                autolog.success('Success:', data);
                getAppNames();
                fileInput.value = ''; // 清空文件输入框
            })
            .catch((error) => {
                console.error('Error:', error);
                fileInput.value = ''; // 清空文件输入框
            });
    }

    function deleteFile(filename) {
        fetch('/api/deleteFile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    autolog.success('Success:', data);
                    getAppNames();
                } else {
                    autolog.error('Error:', data);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function checkServerStatus() {
        fetch('/api/checkServerStatus')
            .then(response => response.json())
            .then(data => {
                let info = [];
                data.message = JSON.parse(data.message);
                for (let key in data.message) {
                    info.push(`${key}: ${data.message[key]}`);
                }
                clicklog.info(info.join('\n'));
            })
            .catch(error => console.error('请求失败：', error));
    }

    function send() {
        let info = document.getElementById('infoback').value;
        fetch('/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ info })
        }).then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function openBlog() {
        // window.open('/blog');
        window.open('https://honghurumeng.github.io/', '_blank');
    }

    function openRouge() {
        window.open('/rouge.html', '_blank');
    }

    function open3d() {
        window.open('/threejs/index.html', '_blank');
    }

    function openlaygame() {
        window.open('/layGame/index.html', '_blank');
    }

    document.addEventListener('DOMContentLoaded', function () {
        getAppNames();
    });

    function getAppNames() {
        fetch('/api/getAppNames')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.data = data.data.filter(item => item !== '.gitignore' && item !== '.DS_Store');
                    let table = document.getElementById('download-table');
                    let header = table.rows[0];
                    table.innerHTML = '';
                    table.appendChild(header);
                    data.data.forEach(appName => {
                        var tr = document.createElement('tr');
                        var td1 = document.createElement('td');
                        td1.innerText = appName;
                        var td2 = document.createElement('td');
                        var btn = document.createElement('button');
                        btn.innerText = 'Download';
                        btn.onclick = debounce(function () {
                            window.open('/api/downloadApp/' + appName);
                        }, 1000); // 1000ms delay
                        var info = document.createElement('button');
                        info.innerText = 'Info';
                        info.onclick = debounce(function () {
                            getFileInfo(appName);
                        }, 1000); // 1000ms delay
                        var deleteBtn = document.createElement('button');
                        deleteBtn.innerText = 'Delete';
                        deleteBtn.onclick = debounce(function () {
                            confirmDelFile(appName);
                        }, 1000); // 1000ms delay
                        td2.appendChild(btn);
                        td2.appendChild(info);
                        td2.appendChild(deleteBtn);
                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        table.appendChild(tr);
                    });
                    autolog.success('下载列表已更新');
                } else {
                    autolog.error('获取下载列表失败');
                    // document.getElementById('app-name').innerHTML = data.message;
                }
            })
            .catch(error => console.error('请求失败：', error));
    }

    function getFileInfo(filename) {
        fetch(`/api/getFileInfo?filename=${encodeURIComponent(filename)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    let info = '文件创建时间：' + formatTime(data.data.birthtimeMs) + '\n' +
                        '文件修改时间：' + formatTime(data.data.mtimeMs) + '\n' +
                        '文件大小：' + formatSize(data.data.size);
                    clicklog.info(info);
                } else {
                    throw new Error(data.message);
                }
            });
    }

    function formatSize(size) {
        if (size < 1024) {
            return size + 'B';
        } else if (size < 1024 * 1024) {
            return (size / 1024).toFixed(2) + 'KB';
        } else {
            return (size / 1024 / 1024).toFixed(2) + 'MB';
        }
    }

    function formatTime(time) {
        var date = new Date(time);
        Y = date.getFullYear() + '-';
        M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
        D = date.getDate() < 10 ? '0' + date.getDate() + ' ' : date.getDate() + ' ';
        h = date.getHours() < 10 ? '0' + date.getHours() + ':' : date.getHours() + ':';
        m = date.getMinutes() < 10 ? '0' + date.getMinutes() + ':' : date.getMinutes() + ':';
        s = date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds();
        return Y + M + D + h + m + s;
    }

    function confirmDelFile(filename) {
        if (confirm(`Are you sure to delete ${filename}?`)) {
            deleteFile(filename);
        }
    }

    function debounce(func, wait, immediate = true) {
        let timeout;
        return function () {
            const context = this, args = arguments;
            const later = function () {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }
</script>

</html>